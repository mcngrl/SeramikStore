@using Microsoft.Extensions.Localization
@using SeramikStore.Web.Localization
@model SeramikStore.Web.ViewModels.AddressSelectViewModel
@inject IStringLocalizer<CartResource> L

@{
    ViewData["Title"] = L["Teslimat Adresi"];
    var culture = System.Globalization.CultureInfo.CurrentCulture;
    var araToplam = Model.TotalAmount;
    var kargo = Model.CargoAmount;
    var toplam = Model.GrandTotal;
    var CurrencyCode = Model.CurrencyCode.ToString().ToUpper();
}

<div class="container mt-8">
    <h4 class="mb-3">@L["Teslimat Adresim"]</h4>
    <form asp-controller="Order" asp-action="PaymentInfo" method="post">
        <div class="row">
            <!-- ================= SOL TARAF : ADRESLER ================= -->
            <div class="col-md-8">
                <div class="text-end">
                <a asp-controller="UserAddress"
                   asp-action="Create"
                   asp-route-returnUrl="@Context.Request.Path"
                   class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-1"></i>
                    @L["Yeni Adres Ekle"]
                </a>
                </div>
                @foreach (var address in Model.Addresses)
                {
                    <div class="card mb-3 shadow-sm address-card">
                        <div class="card-body d-flex align-items-start">
                            <input type="radio"
                                   asp-for="SelectedAddressId"
                                   value="@address.Id"
                                   class="form-check-input mt-2 me-3  address-radio" />

                            <div class="flex-grow-1">
                                <strong>@address.Baslik</strong>
                                <div>@address.Ad @address.Soyad</div>
                                <div class="text-muted small">
                                    @address.Mahalle, @address.Ilce / @address.Il
                                </div>
                                <div class="text-muted small">@address.Adres</div>
                                <div class="text-muted small">@address.Telefon</div>
                            </div>

                            <a asp-controller="UserAddress"
                               asp-action="Edit"
                               asp-route-id="@address.Id"
                               asp-route-returnUrl="@Context.Request.Path"
                               class="btn btn-sm btn-outline-warning">
                                @L["Güncelle"]
                            </a>
                        </div>
                    </div>
                }
                <span asp-validation-for="SelectedAddressId"
                      class="text-danger small"></span>
            </div>




            <!-- ================= SAĞ TARAF : ÖZET ================= -->
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="mb-3">@L["Sipariş Özeti"]</h5>

                        <div class="d-flex justify-content-between mb-2">
                            <span>@L["Sipariş Tutarı"]</span>
                            <span>@araToplam.ToString("N2", culture) @CurrencyCode</span>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>@L["Kargo Tutarı"]</span>
                            <span>@kargo.ToString("N2", culture) @CurrencyCode</span>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>@L["Toplam Tutar"]</span>
                            <span>@toplam.ToString("N2", culture) @CurrencyCode</span>
                        </div>

                        <!-- ONAY -->
                        <div class="form-check mt-3">
                            <input class="form-check-input"
                                   asp-for="TermsAccepted" id="TermsAccepted" />
                            <label class="form-check-label small" asp-for="TermsAccepted">
                                @L["Ön bilgilendirme formunu ve Mesafeli satış sözleşmesini onaylıyorum."]
                            </label>
                            <a asp-controller="Home" asp-action="MesafeliSatis">@L["Mesafeli Satış Sözleşmesi"]</a>
                        </div>
                         <span asp-validation-for="TermsAccepted"
                              class="text-danger small"></span>
                        <div id="formAlert"
                             class="alert alert-warning d-none"
                             role="alert"
                             data-address-required="@L["Lütfen bir teslimat adresi seçiniz."].Value"
                             data-terms-required="@L["Lütfen devam etmeden önce ön bilgilendirme formunu ve satış sözleşmesini onaylayınız."].Value">
                            <span id="formAlertText"></span>
                        </div>

                        <!-- SUBMIT -->
                        <button type="submit" class="btn btn-success w-100 mt-3" id="btnSubmitPaymentInfo">
                            @L["Ödeme Yap"]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


@section Scripts {
    <script>
            document.querySelector("form").addEventListener("submit", function (e) {
            const addressSelected = document.querySelector("input[name='SelectedAddressId']:checked");
            const termsAccepted = document.querySelector("input[name='TermsAccepted']").checked;

            const alertBox = document.getElementById("formAlert");
            const alertText = document.getElementById("formAlertText");

            const addressMsg = alertBox.dataset.addressRequired;
            const termsMsg = alertBox.dataset.termsRequired;

            let messages = [];

            if (!addressSelected) {
                messages.push(addressMsg);
            }

            if (!termsAccepted) {
                messages.push(termsMsg);
            }

            if (messages.length > 0) {
                e.preventDefault();
                alertText.innerHTML = messages.join("<br><br>");
                alertBox.classList.remove("d-none");
                alertBox.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });

    </script>

    <script>
        (function () {

            function updateSelectedCards() {
                document.querySelectorAll(".address-card").forEach(card => {
                    const radio = card.querySelector(".address-radio");
                    if (!radio) return;

                    card.classList.toggle(
                        "address-card-selected",
                        radio.checked
                    );
                });
            }

            function bindCardClicks() {
                document.querySelectorAll(".address-card").forEach(card => {

                    card.addEventListener("click", function (e) {

                        // Edit linkine basıldıysa seçim yapma
                        if (e.target.closest("a")) return;

                        const radio = card.querySelector(".address-radio");
                        if (!radio) return;

                        radio.checked = true;
                        updateSelectedCards();
                    });
                });
            }

            // Normal ilk yükleme
            document.addEventListener("DOMContentLoaded", function () {
                bindCardClicks();
                updateSelectedCards();
            });

            // 🔥 BACK / FORWARD ile gelince
            window.addEventListener("pageshow", function () {
                updateSelectedCards();
            });

        })();
    </script>



}
